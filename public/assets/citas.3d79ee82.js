import{a as g,m as C}from"./Alert.e0b33391.js";import{c as j}from"./sesion.328a2aba.js";import{S as h}from"./sweetalert2.all.5497c4f7.js";function x(e){const t={weekday:"long",year:"numeric",month:"long",day:"numeric"},o=new Date(e),a=o.getMonth(),n=o.getDate()+2,r=o.getFullYear();return new Date(Date.UTC(r,a,n)).toLocaleDateString("es-ES",t)}function M(){let e=new Date,t=e.getFullYear(),o=e.getDate(),a=e.getMonth();if(a=a+1,a<10)var n="0"+a;else var n=a.toString;document.querySelector("#fecha").min=t+"-"+n+"-"+o}let s=1,A=1,O=3,b=null;const l={nombre:"",fecha:"",hora:"",servicios:[]},q=document.querySelector(".listado-citas");document.addEventListener("DOMContentLoaded",function(){k()});function k(){ee(),E(),B(),w(),R(),_(),N(),z(),P(),G(),M(),J(),I(),Z(),j()}function E(){const e=document.querySelector(".mostrar");e&&e.classList.remove("mostrar"),document.querySelector(`#paso-${s}`).classList.add("mostrar");const o=document.querySelector(".actual");o&&o.classList.remove("actual"),document.querySelector(`[data-paso="${s}"]`).classList.add("actual"),P()}function B(){document.querySelectorAll(".tabs button").forEach(t=>{t.addEventListener("click",function(o){s=parseInt(o.target.dataset.paso),E(),w()})})}function w(){const e=document.querySelector("#anterior"),t=document.querySelector("#siguiente");s===1?(e.classList.add("ocultar-paginador"),t.classList.remove("ocultar-paginador")):s===3?(e.classList.remove("ocultar-paginador"),t.classList.add("ocultar-paginador"),I()):s===4?(e.classList.add("ocultar-paginador"),t.classList.add("ocultar-paginador")):(e.classList.remove("ocultar-paginador"),t.classList.remove("ocultar-paginador")),E()}function R(){document.querySelector("#anterior").addEventListener("click",function(){s<=A||(s--,w())})}function _(){document.querySelector("#siguiente").addEventListener("click",function(){s>=O||(s++,w())})}async function N(){try{const t=await(await fetch(`${g}/servicios`)).json();V(t)}catch(e){console.log(e)}}function V(e){e.forEach(t=>{const{id:o,nombre:a,precio:n}=t,r=document.createElement("P");r.classList.add("nombre-servicio"),r.textContent=a;const i=document.createElement("P");i.classList.add("precio-servicio"),i.textContent=`$${n}`;const c=document.createElement("DIV");c.classList.add("servicio"),c.dataset.idServicio=o,c.onclick=function(){Y(t)},c.appendChild(r),c.appendChild(i),document.querySelector("#servicios").appendChild(c)})}function Y(e){const{id:t}=e,{servicios:o}=l,a=document.querySelector(`[data-id-servicio="${t}"]`);o.some(n=>n.id===t)?(l.servicios=o.filter(n=>n.id!==t),a.classList.remove("seleccionado")):(l.servicios=[...o,e],a.classList.add("seleccionado"))}function z(){document.querySelector("#nombre").value=localStorage.getItem("user"),document.querySelector("#nombreCliente").textContent=localStorage.getItem("user"),l.nombre=document.querySelector("#nombre").value}function G(){document.querySelector("#fecha").addEventListener("input",function(t){const o=new Date(t.target.value).getUTCDay();[0].includes(o)?(t.target.value="",C("Los domingos no abrimos.","error",".formulario")):l.fecha=t.target.value})}function J(){document.querySelector("#hora").addEventListener("input",function(t){const o=t.target.value;let[a,n]=o.split(":");n="00",t.target.value=`${a}:${n}`,a<9||a>18?(t.target.value="",C("hora no valida, cerrado","error",".formulario")):l.hora=t.target.value})}function I(){l.nombre=document.querySelector("#nombre").value;const e=document.querySelector(".contenido-resumen");for(;e.firstChild;)e.removeChild(e.firstChild);if(Object.values(l).includes("")||l.servicios.length===0)return C("Faltan datos o servicios","error",".contenido-resumen",!1);const{nombre:t,fecha:o,hora:a,servicios:n}=l,r=document.createElement("H2");r.textContent="Resumen de Servicios",e.appendChild(r);let i=0;n.forEach(u=>{const{precio:T,nombre:H}=u,U=T.replace(/\./g,"");i+=parseFloat(U);const L=document.createElement("DIV");L.classList.add("contenedor-servicios");const $=document.createElement("P");$.textContent=H;const D=document.createElement("P");D.innerHTML=`<span>Precio:</span> ${T}`,L.appendChild($),L.appendChild(D),e.appendChild(L)});const c=i.toLocaleString("es-ES",{minimumFractionDigits:0,maximumFractionDigits:0}),v=document.createElement("P");v.classList.add("total-servicios"),v.innerHTML=`<span>Total a pagar:</span> ${c}`,e.appendChild(v);const y=document.createElement("H2");y.textContent="Resumen de Cita",e.appendChild(y);const m=document.createElement("P");m.innerHTML=`<span>Nombre:</span> ${t}`;const p=document.createElement("P");p.innerHTML=`<span>Fecha:</span> ${x(o)}`;const S=document.createElement("P");S.innerHTML=`<span>Hora:</span> ${a} Horas`;const d=document.createElement("DIV");d.classList.add("txt-center"),d.style.marginBottom="20px";const f=document.createElement("BUTTON");f.classList.add("boton"),f.textContent="Reservar Cita",d.appendChild(f),f.onclick=K,e.appendChild(m),e.appendChild(p),e.appendChild(S),e.appendChild(d)}async function K(){localStorage.getItem("id")||(b=await X());const{fecha:e,hora:t,servicios:o}=l,a=o.map(r=>r.id),n=new FormData;n.append("fecha",e),n.append("hora",t),n.append("usuarioId",localStorage.getItem("id")?localStorage.getItem("id"):b),n.append("servicios",a.toString());try{const i=await(await fetch(`${g}/citas`,{method:"POST",body:n})).json();i.respuesta.tipo==="exito"?(await Q(e,t,o,localStorage.getItem("id")?localStorage.getItem("id"):b),h.fire("Muy bien!",i.respuesta.mensaje,"success").then(()=>{s=4,E()})):i.respuesta.mensaje==="Ya existe una cita programada para esa fecha y hora, porfavor seleccione otra fecha u hora."&&h.fire({icon:"error",title:"Lo sentimos!",text:i.respuesta.mensaje})}catch{h.fire({icon:"error",title:"Oops...",text:"Hubo un error al guardar la cita"})}}async function Q(e,t,o,a){try{const r=await(await fetch(`${g}/usuario/${a}`)).json();emailjs.send("service_g5hphjt","template_3i0zn3m",{to_name:r.nombre+" "+r.apellido,fecha:e,hora:t,servicios:o.map(i=>i.nombre).join(", "),from_name:r.nombre+" "+r.apellido,reply_to:r.email})}catch(n){console.log(n)}}async function P(){try{const t=await(await fetch(`${g}/citas/cliente/${localStorage.getItem("id")?localStorage.getItem("id"):b}`)).json();if(t.length===0)return C("No has reservado una cita aun","error",".listado-citas",!1);W(t)}catch(e){console.log(e)}}function W(e){q.innerHTML="";let t=null,o=null,a=null,n=0;if(e.forEach(r=>{const{precio:i,fecha:c,hora:v,servicio:y,id:m}=r;if(t!==m){if(o){const d=document.createElement("P");d.classList.add("total-servicios");const f=n.toLocaleString("es-ES",{minimumFractionDigits:0,maximumFractionDigits:0});d.innerHTML=`<span>Total a pagar:</span> ${f}`;const u=document.createElement("BUTTON");u.textContent="Cancelar cita",u.classList.add("btn-eliminar"),u.style.height="auto",u.addEventListener("click",function(){F(t)}),a.appendChild(d),a.appendChild(u),o.appendChild(a),q.appendChild(o)}n=0,t=m,o=document.createElement("UL"),o.classList.add("citas");const S=document.createElement("LI");S.innerHTML=`
                <p>ID: <span>${m}</span></p>
                <p>Hora: <span>${v}</span></p>
                <p>Fecha: <span>${x(c)}</span></p>
                <h2>Servicios</h2>
            `,o.appendChild(S),a=document.createElement("DIV"),a.classList.add("opciones")}n+=parseFloat(i.replace(/\./g,""));const p=document.createElement("P");p.classList.add("servicioCita"),p.textContent=`${y} : ${i}`,a.appendChild(p)}),o){const r=document.createElement("P");r.classList.add("total-servicios");const i=n.toLocaleString("es-ES",{minimumFractionDigits:0,maximumFractionDigits:0});r.innerHTML=`<span>Total a pagar:</span> ${i}`;const c=document.createElement("BUTTON");c.textContent="Cancelar cita",c.classList.add("btn-eliminar"),c.style.height="auto",c.addEventListener("click",function(){F(t)}),a.appendChild(r),a.appendChild(c),o.appendChild(a),q.appendChild(o)}}async function F(e){h.fire({title:"Estas seguro/a de cancelar la cita?",showCancelButton:!0,confirmButtonText:"Confirmar"}).then(async t=>{if(t.isConfirmed)try{const a=await(await fetch(`${g}/citas/eliminar/${e}`,{method:"POST"})).json();h.fire("Muy bien!",a.mensaje,"success").then(()=>{window.location.reload()})}catch{h.fire({icon:"error",title:"Oops...",text:"Hubo un error al cancelar la cita"})}})}async function X(){const e=document.querySelector("#nombre").value,t=document.querySelector("#apellido").value,o=document.querySelector("#telefono").value,a=document.querySelector("#email").value;if(e===""||t===""||o===""||a==="")return C("Todos los campos son obligatorios","error",".formulario");const n=new FormData;n.append("nombre",e),n.append("apellido",t),n.append("email",a),n.append("contrase\xF1a",o),n.append("telefono",o),n.append("admin",0),n.append("confirmado",0),n.append("token","");try{const i=await(await fetch(`${g}/usuarios`,{method:"POST",body:n})).json();return i.tipo==="error"?console.log("Error creando el usuario"):(console.log("Usuario creado correctamente"),i.usuario_id.id)}catch(r){console.log(r)}}async function Z(){const e=document.querySelector("#nombre"),t=document.querySelector(".barra"),o=document.querySelector("#campoApellido"),a=document.querySelector("#campoTelefono"),n=document.querySelector("#campoCorreo");localStorage.getItem("id")?(o.style.display="none",a.style.display="none",n.style.display="none",e.disabled=!0):t.style.display="none"}function ee(){const e=new URL(window.location.href),t=new URLSearchParams(e.search),o=t.get("user"),a=t.get("name");o&&a&&(localStorage.setItem("id",o),localStorage.setItem("user",a),s=4)}
